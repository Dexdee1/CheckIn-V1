<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>Work Smart</title>
    <meta name="apple-mobile-web-app-title" content="WorkSmart">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Noto Sans Thai', sans-serif; 
            background-color: #f1f5f9; 
            font-size: 14px; 
            color: #334155; 
            overscroll-behavior-y: contain; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠ Refresh ‡πÉ‡∏ô iPhone */
            
            /* ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏î‡∏±‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏•‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏™‡πà‡∏ß‡∏ô Status Bar ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ */
            padding-top: env(safe-area-inset-top);
            min-height: calc(100vh + env(safe-area-inset-top));
        }
        
        /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ß‡πâ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏Ç‡∏≠‡∏á Container ‡∏´‡∏•‡∏±‡∏Å */
        .main-container {
            padding-top: 1.5rem; /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏û‡πâ‡∏ô Safe Area ‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß */
        }

        .glass-popup { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.4); }
        .pop-in { animation: springIn 0.45s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        .shift-active { border: 3px solid #3b82f6 !important; background-color: #ffffff !important; box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.2); }
        .date-tag { background: #e2e8f0; color: #475569; padding: 4px 10px; border-radius: 99px; font-weight: 700; font-size: 11px; display: flex; align-items: center; gap: 5px; }
        .activity-item { animation: slideInLeft 0.5s ease-out; border-bottom: 1px solid #f1f5f9; }
        @keyframes slideInLeft { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes springIn { from { opacity: 0; transform: scale(0.9) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
    </style>
</head>
<body class="antialiased">
    <div class="max-w-md mx-auto min-h-screen flex flex-col p-5 main-container">
        
        <div class="flex flex-col items-center mb-6 space-y-3">
            <h1 class="text-4xl font-black text-slate-800 uppercase tracking-tighter italic">WORK <span class="text-blue-600">SMART</span></h1>
            <div class="flex gap-2 w-full justify-center">
                <button onclick="showRulePopup()" class="flex-1 max-w-[120px] font-black bg-white text-slate-500 py-2.5 rounded-full uppercase border border-slate-200 shadow-sm text-[11px] italic">‡∏Å‡∏é‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö</button>
                <button onclick="location.href='admin.html'" class="flex-1 max-w-[120px] font-black bg-yellow-300 text-black py-2.5 rounded-full uppercase border border-yellow-400 shadow-sm text-[11px] italic">‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</button>
            </div>
        </div>

        <div class="bg-white/80 backdrop-blur-md p-6 rounded-[2.5rem] shadow-xl shadow-slate-200/50 border border-white mb-6 space-y-5">
            <div>
                <label class="font-black text-slate-400 uppercase tracking-widest ml-4 text-[10px]">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                <select id="empList" class="w-full p-4 bg-slate-50 rounded-2xl border-none outline-none font-bold text-slate-700 mt-1 shadow-inner italic text-sm">
                    <option value="">-- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• --</option>
                </select>
            </div>
            <div>
                <label class="font-black text-slate-400 uppercase tracking-widest ml-4 text-[10px]">‡πÄ‡∏ß‡πá‡∏ö‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</label>
                <select id="locList" class="w-full p-4 bg-slate-50 rounded-2xl border-none outline-none font-bold text-slate-700 mt-1 shadow-inner italic text-sm">
                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡πá‡∏ö‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô --</option>
                </select>
            </div>
        </div>

        <main class="space-y-8">
            <section class="space-y-4">
                <div class="flex items-center gap-2 px-2">
                    <div class="w-2 h-5 bg-orange-500 rounded-full"></div>
                    <h2 class="font-black text-slate-700 italic uppercase text-sm">‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏∞ 12 ‡∏ä‡∏°.</h2>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <button id="shiftMorning" onclick="selectShift(this, '‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤')" class="shift-btn bg-white p-5 rounded-[2rem] shadow-sm border-2 border-transparent font-bold transition-all text-center">
                        <span class="block text-2xl mb-1">‚òÄÔ∏è</span>
                        <span class="block text-lg italic font-black">‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤</span>
                    </button>
                    <button id="shiftNight" onclick="selectShift(this, '‡∏Å‡∏∞‡∏î‡∏∂‡∏Å')" class="shift-btn bg-white p-5 rounded-[2rem] shadow-sm border-2 border-transparent font-bold transition-all text-center">
                        <span class="block text-2xl mb-1">üåô</span>
                        <span class="block text-lg italic font-black">‡∏Å‡∏∞‡∏î‡∏∂‡∏Å</span>
                    </button>
                </div>
                <div class="grid grid-cols-2 gap-4 pt-2">
                    <button onclick="handleAction('‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô')" class="bg-emerald-500 text-white py-5 rounded-[2.2rem] font-black shadow-lg shadow-emerald-200 active:scale-95 transition-all text-lg italic uppercase">‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</button>
                    <button onclick="handleAction('‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô')" class="bg-rose-500 text-white py-5 rounded-[2.2rem] font-black shadow-lg shadow-rose-200 active:scale-95 transition-all text-lg italic uppercase">‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô</button>
                </div>
            </section>

            <section class="space-y-4">
                <div class="flex items-center gap-2 px-2">
                    <div class="w-2 h-5 bg-blue-500 rounded-full"></div>
                    <h2 class="font-black text-slate-700 italic uppercase text-sm">‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏á‡∏≤‡∏ô & ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</h2>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="handleLeave(this, '‡∏•‡∏≤‡∏Å‡∏¥‡∏à')" class="bg-white py-4 rounded-2xl shadow-sm text-amber-600 font-black border border-white italic text-[13px]">üìù ‡∏•‡∏≤‡∏Å‡∏¥‡∏à</button>
                    <button onclick="handleLeave(this, '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢')" class="bg-white py-4 rounded-2xl shadow-sm text-rose-600 font-black border border-white italic text-[13px]">ü§í ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</button>
                    <button onclick="handleLeave(this, '‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏¢‡∏∏‡∏î')" class="bg-white py-4 rounded-2xl shadow-sm text-emerald-600 font-black border border-white italic text-[13px]">üîÑ ‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏¢‡∏∏‡∏î</button>
                    <button onclick="handleLeave(this, '‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ß‡∏•‡∏≤')" class="bg-white py-4 rounded-2xl shadow-sm text-blue-600 font-black border border-white italic text-[13px]">üèÉ ‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô</button>
                </div>
            </section>

            <section class="mt-4 pb-10">
                <div class="flex justify-between items-center px-2 mb-4">
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-5 bg-slate-400 rounded-full"></div>
                        <h2 class="font-black text-slate-700 italic uppercase text-[13px]">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (5 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</h2>
                    </div>
                    <div id="loadingStatus" class="hidden text-[10px] font-bold text-blue-500 animate-pulse uppercase">Updating...</div>
                </div>
                <div class="bg-white/50 backdrop-blur-sm rounded-[2rem] border border-white overflow-hidden shadow-sm shadow-slate-200">
                    <div id="recentActivityList" class="divide-y divide-slate-100">
                        <div class="p-6 text-center text-slate-400 italic text-xs">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î...</div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="leaveModal" class="fixed inset-0 z-[1100] hidden flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl pop-in max-h-[90vh] overflow-y-auto">
            <h3 id="leaveModalTitle" class="text-2xl font-black text-slate-800 italic uppercase mb-4 underline decoration-blue-500 text-center">‡πÅ‡∏à‡πâ‡∏á‡∏•‡∏≤‡∏á‡∏≤‡∏ô</h3>
            <div class="space-y-4 text-left">
                <div>
                    <label id="date1Label" class="font-black text-slate-400 text-[10px] uppercase ml-2 tracking-widest italic">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤</label>
                    <div class="flex gap-2 mt-1">
                        <input type="date" id="dateInput1" class="flex-1 p-4 bg-slate-50 rounded-2xl border-none outline-none font-bold text-slate-700 shadow-inner text-sm">
                        <button onclick="addDateToList(1)" class="bg-blue-600 text-white px-4 rounded-2xl font-black text-xl">+</button>
                    </div>
                    <div id="dateListDisplay1" class="flex flex-wrap gap-2 mt-3"></div>
                </div>
                <div id="date2Area" class="hidden">
                    <label class="font-black text-blue-500 text-[10px] uppercase ml-2 tracking-widest italic">‡∏°‡∏≤‡πÅ‡∏ó‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                    <div class="flex gap-2 mt-1">
                        <input type="date" id="dateInput2" class="flex-1 p-4 bg-blue-50 rounded-2xl border-2 border-blue-100 outline-none font-bold text-slate-700 text-sm">
                        <button onclick="addDateToList(2)" class="bg-blue-600 text-white px-4 rounded-2xl font-black text-xl">+</button>
                    </div>
                    <div id="dateListDisplay2" class="flex flex-wrap gap-2 mt-3"></div>
                </div>
                <div>
                    <label class="font-black text-slate-400 text-[10px] uppercase ml-2 tracking-widest italic">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                    <textarea id="leaveNote" rows="2" placeholder="..." class="w-full p-4 bg-slate-50 rounded-2xl border-none outline-none font-bold text-slate-700 mt-1 shadow-inner text-sm"></textarea>
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button onclick="closeLeaveModal()" class="flex-1 bg-slate-100 text-slate-500 py-4 rounded-2xl font-black uppercase italic">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="confirmLeaveSubmit()" class="flex-[2] bg-blue-600 text-white py-4 rounded-2xl font-black uppercase italic">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
        </div>
    </div>

    <div id="appToast" class="fixed inset-0 z-[1000] hidden flex items-center justify-center p-6 bg-slate-900/40 backdrop-blur-[3px]">
        <div id="toastContent" class="glass-popup w-full max-w-[320px] rounded-[3rem] p-10 shadow-2xl text-center">
            <div id="toastIcon" class="text-7xl mb-6">‚úÖ</div>
            <h3 id="toastTitle" class="font-black text-slate-800 uppercase text-xl mb-2 italic">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h3>
            <p id="toastMsg" class="font-bold text-slate-500 leading-relaxed text-sm"></p>
            <div id="toastBar" class="w-full bg-slate-100 h-1.5 mt-8 rounded-full overflow-hidden">
                <div id="toastProgress" class="bg-blue-500 h-full w-0 transition-all duration-[2000ms] ease-linear"></div>
            </div>
            <button id="toastCloseBtn" onclick="closeToast()" class="hidden w-full bg-slate-800 text-white py-4 rounded-2xl font-black uppercase italic mt-6">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbyEqPzr-R_4p8_evzSiaVSisROSm-mPgp0MR8TZpxwCnL5NnjaHCKlcFV0EobPWbdD4/exec";
        const COOLDOWN_MINUTES = 5; 
        let selectedShiftName = "";
        let isProcessing = false;
        let datesSet1 = [];
        let datesSet2 = [];
        let currentLeaveType = "";

        window.onload = () => fetchInitialData();

        async function fetchInitialData() {
            try {
                const res = await fetch(API_URL + "?action=getData");
                const data = await res.json();
                document.getElementById('empList').innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô --</option>' + data.employees.map(e => `<option value="${e}">${e}</option>`).join('');
                document.getElementById('locList').innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡πá‡∏ö‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô --</option>' + data.locations.map(l => `<option value="${l}">${l}</option>`).join('');
                renderActivities(data.recent);
            } catch (e) { document.getElementById('empList').innerHTML = '<option value="">‚ùå ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option>'; }
        }

        async function loadRecentActivities() {
            document.getElementById('loadingStatus').classList.remove('hidden');
            try {
                const res = await fetch(API_URL + "?action=getRecent");
                const data = await res.json();
                renderActivities(data.recent);
            } catch (e) { console.error("Load fail"); }
            finally { document.getElementById('loadingStatus').classList.add('hidden'); }
        }

        function renderActivities(list) {
            const listEl = document.getElementById('recentActivityList');
            if (!list || list.length === 0) {
                listEl.innerHTML = '<div class="p-6 text-center text-slate-400 italic text-xs">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>';
                return;
            }
            listEl.innerHTML = list.map(item => `
                <div class="p-4 flex justify-between items-center bg-white/40 activity-item">
                    <div class="flex flex-col">
                        <span class="font-black text-slate-700 text-[13px]">${item.name}</span>
                        <span class="text-[10px] text-slate-400 font-bold uppercase tracking-tighter">${item.time} | ${item.shift}</span>
                        ${item.duration ? `<span class="text-[11px] text-blue-600 font-black italic mt-1 animate-pulse">‚è±Ô∏è ${item.duration}</span>` : ''}
                    </div>
                    <div class="flex flex-col items-end gap-1">
                        <span class="px-3 py-1 rounded-full text-[9px] font-black italic uppercase 
                            ${item.type === '‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô' ? 'bg-emerald-100 text-emerald-600' : 
                              item.type === '‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô' ? 'bg-rose-100 text-rose-600' : 'bg-blue-100 text-blue-600'}">
                            ${item.type}
                        </span>
                        <span class="text-[9px] text-slate-400 italic">${item.loc || ''}</span>
                    </div>
                </div>
            `).join('');
        }

        async function executeSubmit(name, loc, type, shift, note, saveCool) {
            try {
                isProcessing = true;
                document.body.style.opacity = "0.6";
                const res = await fetch(API_URL, { method: "POST", body: JSON.stringify({ name, location: loc, type, shift, note }) });
                const data = await res.json();
                if(data.status === "success") {
                    if (saveCool) localStorage.setItem(`last_${name}_${type}`, new Date().toISOString());
                    
                    let successMsg = `${type}<br>${note}`;
                    if (data.duration) successMsg += `<br><span class="text-blue-600 font-black">‚è±Ô∏è ‡∏£‡∏ß‡∏°‡πÄ‡∏ß‡∏•‡∏≤: ${data.duration}</span>`;
                    
                    showModernToast("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!", successMsg, "‚úÖ", true);
                    loadRecentActivities();
                }
            } catch (e) {
                showModernToast("Error", "‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡πà‡∏∞", "üì°", false);
            } finally {
                isProcessing = false;
                document.body.style.opacity = "1";
            }
        }

        function checkShiftWindow(action) {
            const now = new Date();
            const time = now.getHours() + (now.getMinutes() / 60);
            let start, end;
            if (selectedShiftName === "‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤") {
                if (action === "‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô") { start = 7.0; end = 9.5; } else { start = 18.5; end = 21.0; }
            } else if (selectedShiftName === "‡∏Å‡∏∞‡∏î‡∏∂‡∏Å") {
                if (action === "‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô") { start = 18.5; end = 21.0; } else { start = 6.5; end = 9.5; }
            } else return "NO_SHIFT";
            return (time < start) ? "BEFORE" : (time > end) ? "AFTER" : "OK";
        }

        async function handleAction(type) {
            if (isProcessing) return;
            const name = document.getElementById('empList').value;
            const loc = document.getElementById('locList').value;

            if (!name) return showModernToast("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡πà‡∏∞", "üë§", false);
            if (!loc) return showModernToast("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡πá‡∏ö‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ñ‡πà‡∏∞", "üìç", false);
            if (!selectedShiftName) return showModernToast("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å '‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤' ‡∏´‡∏£‡∏∑‡∏≠ '‡∏Å‡∏∞‡∏î‡∏∂‡∏Å' ‡∏Ñ‡πà‡∏∞", "‚è∞", false);

            const status = checkShiftWindow(type);
            if (status === "BEFORE") return showModernToast("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤", `‡∏ä‡πà‡∏ß‡∏á ${type} ‡∏Ç‡∏≠‡∏á ${selectedShiftName} ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡πà‡∏∞`, "‚è≥", false);
            if (status === "AFTER") return showModernToast("‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏ß‡∏•‡∏≤", `‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÅ‡∏à‡πâ‡∏á ${type} ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞`, "‚ùå", false);
            
            const lastTime = localStorage.getItem(`last_${name}_${type}`);
            if (lastTime) {
                const diff = (new Date() - new Date(lastTime)) / 60000;
                if (diff < COOLDOWN_MINUTES) return showModernToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ã‡πâ‡∏≥!", `‡∏£‡∏≠‡∏≠‡∏µ‡∏Å ${Math.ceil(COOLDOWN_MINUTES - diff)} ‡∏ô‡∏≤‡∏ó‡∏µ`, "‚è≥", false);
            }
            
            const timeData = getSmartTimeNote(type, selectedShiftName);
            executeSubmit(name, loc, type, selectedShiftName, timeData.note, true);
        }

        function handleLeave(btn, type) {
            if (isProcessing) return;
            const name = document.getElementById('empList').value;
            if (!name) return showModernToast("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö", "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏∞", "‚ö†Ô∏è", false);
            currentLeaveType = type; datesSet1 = []; datesSet2 = []; renderDateTags();
            document.getElementById('leaveModalTitle').innerText = "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: " + type;
            document.getElementById('date2Area').className = (type === '‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏¢‡∏∏‡∏î') ? "block" : "hidden";
            document.getElementById('leaveModal').classList.remove('hidden');
        }

        function addDateToList(num) {
            const input = document.getElementById(`dateInput${num}`);
            if (!input.value) return;
            const target = (num === 1) ? datesSet1 : datesSet2;
            if (!target.includes(input.value)) { target.push(input.value); target.sort(); renderDateTags(); }
            input.value = "";
        }

        function removeDate(num, val) {
            if (num === 1) datesSet1 = datesSet1.filter(d => d !== val); else datesSet2 = datesSet2.filter(d => d !== val);
            renderDateTags();
        }

        function renderDateTags() {
            document.getElementById('dateListDisplay1').innerHTML = datesSet1.map(d => `<span class="date-tag">${d} <button onclick="removeDate(1,'${d}')" class="text-rose-500">√ó</button></span>`).join('');
            document.getElementById('dateListDisplay2').innerHTML = datesSet2.map(d => `<span class="date-tag bg-blue-100 text-blue-700">${d} <button onclick="removeDate(2,'${d}')" class="text-rose-500">√ó</button></span>`).join('');
        }

        async function confirmLeaveSubmit() {
            if (datesSet1.length === 0) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏∞");
            let note = `[${currentLeaveType}] ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${datesSet1.join(', ')}`;
            if (currentLeaveType === '‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏¢‡∏∏‡∏î') note += ` | ‡πÅ‡∏ó‡∏ô: ${datesSet2.join(', ')}`;
            closeLeaveModal();
            executeSubmit(document.getElementById('empList').value, document.getElementById('locList').value, currentLeaveType, "-", note, false);
        }

        function getSmartTimeNote(type, shift) {
            const now = new Date(); const cur = (now.getHours() * 60) + now.getMinutes();
            let target = (type === '‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô') ? (shift === '‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤' ? 480 : 1200) : (shift === '‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤' ? 1110 : 480);
            let diff = cur - target; if (diff > 720) diff -= 1440; if (diff < -720) diff += 1440;
            return { note: `${type} ${diff > 0 ? '‡∏ä‡πâ‡∏≤' : '‡∏Å‡πà‡∏≠‡∏ô'} ${Math.abs(diff)} ‡∏ô‡∏≤‡∏ó‡∏µ` };
        }

        function showModernToast(title, msg, icon, auto) {
            const t = document.getElementById('appToast');
            const progress = document.getElementById('toastProgress');
            const closeBtn = document.getElementById('toastCloseBtn');
            const bar = document.getElementById('toastBar');

            document.getElementById('toastIcon').innerText = icon; 
            document.getElementById('toastTitle').innerText = title; 
            document.getElementById('toastMsg').innerHTML = msg;
            
            t.classList.remove('hidden');
            
            if (auto) {
                bar.classList.remove('hidden');
                closeBtn.classList.add('hidden');
                setTimeout(() => progress.style.width = '100%', 50);
                setTimeout(() => location.reload(), 2500);
            } else {
                bar.classList.add('hidden');
                closeBtn.classList.remove('hidden');
                progress.style.width = '0';
            }
        }

        function closeToast() { document.getElementById('appToast').classList.add('hidden'); }
        function closeLeaveModal() { document.getElementById('leaveModal').classList.add('hidden'); }
        
        function selectShift(btn, name) {
            document.querySelectorAll('.shift-btn').forEach(b => b.classList.remove('shift-active'));
            btn.classList.add('shift-active'); 
            selectedShiftName = name;
        }

        function showRulePopup() {
            const rules = ["1. ‡∏™‡∏≤‡∏¢‡∏ô‡∏≤‡∏ó‡∏µ‡∏•‡∏∞ 5 ‡∏ö‡∏≤‡∏ó", "2. ‡∏•‡∏∑‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô 400.-", "3. ‡∏•‡∏∑‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏≠‡∏≠‡∏Å 250.-", "4. ‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ 15 ‡∏ß‡∏±‡∏ô"];
            showModernToast("‡∏Å‡∏é‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö", `<div class='text-left text-xs bg-slate-50 p-4 rounded-2xl'>${rules.map(r=>`<div>${r}</div>`).join('')}</div>`, "üìã", false);
        }
    </script>
</body>
</html>